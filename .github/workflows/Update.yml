name: Update all files for domain

on:
  workflow_dispatch:
  push:
    paths:
      - "userlist.txt"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read domain
        id: vars
        run: |
          DOMAIN=$(sed -n '3p' userlist.txt)
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT

      - name: Update files
        id: update
        run: |
          DOMAIN="${{ steps.vars.outputs.domain }}"
          CHANGED=false
          
          # 更新JS文件
          for FILE in djs/dis.js djs/ziti.js; do
            if [ -f "$FILE" ]; then
              echo "Updating $FILE"
              cp "$FILE" "${FILE}.bak"
              sed -i "5s|.*|// @match        *://$DOMAIN/*|" "$FILE"
              sed -i "4s|.*|// @version     $(sed -n '4p' "$FILE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | awk -F. -vOFS=. '{$NF=$NF+1; print}')|" "$FILE"
              if ! diff -q "$FILE" "${FILE}.bak" >/dev/null; then
                CHANGED=true
              fi
              rm "${FILE}.bak"
            fi
          done
          
          # 更新ub.txt
          if [ -f "djs/ub.txt" ]; then
            cp djs/ub.txt djs/ub.txt.bak
            sed -i "2s|.*|$DOMAIN##font.jammer|" djs/ub.txt
            if ! diff -q djs/ub.txt djs/ub.txt.bak >/dev/null; then
              CHANGED=true
            fi
            rm djs/ub.txt.bak
          fi
          
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Commit and push
        if: steps.update.outputs.changed == 'true'
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"
          git add djs/
          git commit -m "Update files for domain: ${{ steps.vars.outputs.domain }}"
          git push
