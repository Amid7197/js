name: Update Version on JS File Change

on:
  push:
    paths:
      - 'djs/**/*.js'
    branches: [ main, master ]

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN }}

      - name: Get changed JS files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            djs/**/*.js

      - name: Debug - List changed files
        run: |
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
          echo "Number of changed files: ${{ steps.changed-files.outputs.all_changed_files_count }}"

      - name: Update version in changed files
        if: steps.changed-files.outputs.all_changed_files_count != 0
        id: update-version
        run: |
          changed_files="${{ steps.changed-files.outputs.all_changed_files }}"
          
          if [ -z "$changed_files" ]; then
            echo "No JS files changed"
            exit 0
          fi
          
          # 初始化提交信息
          commit_message="chore: update version in:"
          
          for file in $changed_files; do
            if [ -f "$file" ]; then
              echo "Processing file: $file"
              
              # 读取当前版本号
              current_version_line=$(sed -n '4p' "$file")
              echo "Line 4 content: $current_version_line"
              
              if [[ $current_version_line =~ //\s*@version\s+([0-9]+\.[0-9]+\.[0-9]+) ]]; then
                current_version="${BASH_REMATCH[1]}"
                echo "Current version: $current_version"
                
                # 分割版本号
                IFS='.' read -r major minor patch <<< "$current_version"
                
                # 递增修订版本号
                new_patch=$((patch + 1))
                new_version="$major.$minor.$new_patch"
                echo "New version: $new_version"
                
                # 创建临时文件
                temp_file=$(mktemp)
                
                # 替换第4行的版本号
                awk -v new_version="$new_version" '
                  NR == 4 {
                    if (match($0, /\/\/\s*@version\s+[0-9]+\.[0-9]+\.[0-9]+/)) {
                      print "// @version      " new_version
                    } else {
                      print $0
                    }
                  }
                  NR != 4 { print $0 }
                ' "$file" > "$temp_file"
                
                # 检查替换是否成功
                new_version_line=$(sed -n '4p' "$temp_file")
                if [[ "$new_version_line" == "// @version      $new_version" ]]; then
                  # 替换原文件
                  mv "$temp_file" "$file"
                  echo "✓ Successfully updated $file to version $new_version"
                  commit_message="$commit_message $(basename $file)"
                else
                  echo "✗ Failed to update version in $file"
                  rm "$temp_file"
                fi
              else
                echo "✗ Version pattern not found in line 4 of $file"
              fi
            else
              echo "✗ File not found: $file"
            fi
          done
          
          # 设置输出
          echo "commit_message=${commit_message}" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.changed-files.outputs.all_changed_files_count != 0
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add .
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "${{ steps.update-version.outputs.commit_message }}"
          git push
