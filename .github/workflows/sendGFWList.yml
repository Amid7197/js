name: GFWList Auto Sync (Main Branch)

on:
  push:
    paths:
      - 'userlist.txt'
  schedule:
    - cron: '0 0 * * *'  # 每天北京时间上午8点自动同步
  workflow_dispatch:      # 支持手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    # 必须开启写权限，解决 403 错误
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install idna
          sudo apt-get update
          sudo apt-get install -y openssl curl

      - name: Process Userlist (Punycode & Normalization)
        run: |
          python3 - <<EOF
          import idna
          import os

          input_file = 'userlist.txt'
          output_file = 'userlist.processed.txt'
          
          if not os.path.exists(input_file):
              open(output_file, 'w').close()
              exit()

          with open(input_file, 'r', encoding='utf-8') as f:
              lines = f.readlines()

          results = []
          for line in lines:
              line = line.strip()
              # 保持空行、注释、白名单原样
              if not line or line.startswith(('#', '!', '@@')):
                  results.append(line)
                  continue
              
              try:
                  # 处理可能带 || 的中文域名
                  raw_domain = line.replace('||', '')
                  encoded_domain = idna.encode(raw_domain).decode('ascii')
                  results.append(f"||{encoded_domain}")
              except:
                  results.append(line)

          with open(output_file, 'w', encoding='utf-8') as f:
              f.write('\n'.join(results))
          EOF

      - name: Fetch and Merge
        run: |
          # 下载官方 list.txt
          curl -sS https://raw.githubusercontent.com/gfwlist/gfwlist/master/list.txt -o official_list.txt
          
          # 合并：官方在前，用户自定义在后
          cat official_list.txt > final_list.txt
          echo -e "\n! ---------- My Custom Rules ----------" >> final_list.txt
          cat userlist.processed.txt >> final_list.txt

      - name: Convert to gfwlist.txt (Standard Base64)
        run: |
          # 使用 -A 生成不换行的单行 Base64 字符串
          openssl base64 -in final_list.txt -A | tr -d '\r' > gfwlist.txt

      - name: Commit and Push to Main
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          git add gfwlist.txt
          if git diff --cached --quiet; then
            echo "No changes, skipping push."
          else
            git commit -m "[$(date -u +'%Y-%m-%d %H:%M:%S')] auto sync gfwlist"
            git push origin main
          fi
